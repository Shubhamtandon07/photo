import re
from datetime import datetime, timedelta
import win32com.client as win32

# ===== Keep your existing config values =====
TARGET_MAILBOX = "shubham.tandon@mercedes-benz.com"
WATCH_FOLDER_NAME = "Inbox"
PROCESSED_CATEGORY = "Drafted-NoLLM"

REQUIRE_UNREAD = True
REQUIRE_STRICT_SUBJECT = True
SCAN_LIMIT = 200
PROCESS_PER_RUN = 3

def strict_subject_is_bot(subject: str) -> bool:
    return (subject or "").strip().lower() == "bot"

def get_target_folder():
    ns = win32.Dispatch("Outlook.Application").GetNamespace("MAPI")

    target_store = None
    for st in ns.Stores:
        if TARGET_MAILBOX.lower() in (st.DisplayName or "").lower():
            target_store = st
            break

    if not target_store:
        print("Available stores:")
        for st in ns.Stores:
            print(" -", st.DisplayName)
        raise SystemExit("Target mailbox not found. Adjust TARGET_MAILBOX.")

    inbox = target_store.GetDefaultFolder(6)  # Inbox

    if WATCH_FOLDER_NAME.lower() == "inbox":
        return ns, inbox, target_store.DisplayName, "Inbox"

    for f in inbox.Folders:
        if (f.Name or "").lower() == WATCH_FOLDER_NAME.lower():
            return ns, f, target_store.DisplayName, f.Name

    raise SystemExit(f"Subfolder '{WATCH_FOLDER_NAME}' not found under Inbox.")

def run_bot_once_debug():
    ns, folder, store_name, folder_name = get_target_folder()
    print(f"Mailbox={store_name} | Folder={folder_name}")

    items = folder.Items
    items.Sort("[ReceivedTime]", True)

    drafted = 0
    checked = 0

    # Debug counters
    c_not_mail = 0
    c_has_cat = 0
    c_read = 0
    c_subject = 0
    c_pass = 0

    # Show what Outlook thinks the folder contains
    try:
        print("Items.Count:", items.Count)
    except Exception:
        pass

    for mail in items:
        checked += 1
        if checked > SCAN_LIMIT:
            break
        if drafted >= PROCESS_PER_RUN:
            break

        try:
            # Not a MailItem
            if getattr(mail, "Class", None) != 43:
                c_not_mail += 1
                if checked <= 50:
                    print(f"[SKIP not MailItem] Class={getattr(mail,'Class',None)}")
                continue

            subj = mail.Subject or ""
            unread = bool(getattr(mail, "UnRead", False))
            cats = (mail.Categories or "")

            # Already processed
            if PROCESSED_CATEGORY.lower() in cats.lower():
                c_has_cat += 1
                if checked <= 50:
                    print(f"[SKIP category] Subject='{subj[:80]}' Cats='{cats}'")
                continue

            # Unread gate
            if REQUIRE_UNREAD and not unread:
                c_read += 1
                if checked <= 50:
                    print(f"[SKIP read] Subject='{subj[:80]}' UnRead={unread}")
                continue

            # Subject gate
            if REQUIRE_STRICT_SUBJECT and not strict_subject_is_bot(subj):
                c_subject += 1
                if checked <= 50:
                    print(f"[SKIP subject] Subject='{subj[:80]}' (needs exactly 'bot')")
                continue

            c_pass += 1
            print(f"[PASS] Subject='{subj}' UnRead={unread} Cats='{cats}'")

            # Draft a minimal reply so we know drafting works
            reply = mail.Reply()
            reply.Subject = "DRAFT TEST â€” " + (reply.Subject or "")
            reply.Body = "Draft test created by notebook.\n\n" + (reply.Body or "")
            reply.Save()

            # Mark + category
            try:
                mail.UnRead = False
                mail.Categories = (cats + "," + PROCESSED_CATEGORY).strip(",")
                mail.Save()
            except Exception as e:
                print("WARN: could not mark/categorize:", repr(e))

            drafted += 1
            print("Draft created for:", subj)

        except Exception as e:
            print("ERROR on mail:", repr(e))

    print("\n=== Summary ===")
    print("Checked:", checked)
    print("Drafted:", drafted)
    print("Skip not MailItem:", c_not_mail)
    print("Skip category:", c_has_cat)
    print("Skip read:", c_read)
    print("Skip subject:", c_subject)
    print("Passed filters:", c_pass)

# Run:
# run_bot_once_debug()
